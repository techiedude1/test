<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Barcode Generator</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 600px; /* Adjust as needed */
        }

        h1 {
            color: #333;
            margin-bottom: 25px;
        }

        .input-section {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-section input[type="text"] {
            width: calc(100% - 16px); /* Account for padding */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box; /* Include padding in width */
        }

        .date-fields {
            display: flex;
            align-items: center;
            gap: 5px; /* Space between elements */
        }

        .exp-label {
            font-weight: bold;
            color: #555;
            margin-right: 5px;
        }

        .date-part {
            width: 50px; /* Smaller width for date parts */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            text-align: center;
        }

        .date-separator {
            font-weight: bold;
            color: #555;
        }

        /* This is the preview area for the barcode */
        #barcodeDisplay {
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            border: 1px dashed #eee;
            min-height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Style for the hidden printable area */
        .capture-area {
            display: none; /* Hide this from the user's direct view */
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            width: fit-content; /* Make it as wide as its content */
        }

        .printable-content {
            text-align: left;
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .print-name,
        .print-expiry {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #333;
        }

        .print-name span,
        .print-expiry span {
            font-weight: normal;
            color: #555;
        }

        .print-barcode {
            margin-bottom: 15px;
            text-align: center;
        }

        /* Styling for the barcode SVG itself within the printable area */
        #barcodeSvg {
            max-width: 100%;
            height: auto;
            display: block; /* Remove extra space below SVG */
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 15px;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
    <!-- JsBarcode.js -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</head>
<body>

    <div class="container">
        <h1>Custom Barcode Generator</h1>

        <div class="input-section">
            <label for="name">Name:</label>
            <input type="text" id="name" placeholder="Enter a name">
        </div>

        <div class="input-section">
            <label for="barcodeData">Barcode Data:</label>
            <input type="text" id="barcodeData" placeholder="Enter barcode value">
            <div id="barcodeDisplay">
                <!-- Barcode will be rendered here by JsBarcode for immediate preview -->
                <!-- We'll also target the svg element inside captureArea for the final image -->
            </div>
        </div>

        <div class="input-section">
            <label>Expiration:</label>
            <div class="date-fields">
                <span class="exp-label">Exp:</span>
                <input type="text" id="expDay" class="date-part" placeholder="DD">
                <span class="date-separator">/</span>
                <input type="text" id="expMonth" class="date-part" placeholder="MM">
                <span class="date-separator">/</span>
                <input type="text" id="expYear" class="date-part" placeholder="YYYY">
            </div>
        </div>

        <button id="generateImageBtn">Capture as Image</button>

        <div id="outputImageContainer" class="output-container">
            <!-- The captured image will be displayed here -->
        </div>

        <!-- This is the hidden div that will be captured by html2canvas -->
        <div id="captureArea" class="capture-area">
            <div class="printable-content">
                <div class="print-name">Name: <span id="printName"></span></div>
                <div class="print-barcode">
                    <!-- JsBarcode will render the barcode into this SVG element for the final image -->
                    <svg id="barcodeSvg"></svg>
                </div>
                <div class="print-expiry">
                    Exp: <span id="printExp"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('name');
            const barcodeDataInput = document.getElementById('barcodeData');
            const expDayInput = document.getElementById('expDay');
            const expMonthInput = document.getElementById('expMonth');
            const expYearInput = document.getElementById('expYear');

            // Elements in the hidden capture area
            const printNameSpan = document.getElementById('printName');
            const printExpSpan = document.getElementById('printExp');
            const barcodeSvgElement = document.getElementById('barcodeSvg'); // The SVG element for JsBarcode

            // Input preview element for barcode
            const barcodeDisplayDiv = document.getElementById('barcodeDisplay');

            const captureArea = document.getElementById('captureArea');
            const generateImageBtn = document.getElementById('generateImageBtn');

            // --- Event Listeners for Real-time Updates ---

            nameInput.addEventListener('input', () => {
                printNameSpan.textContent = nameInput.value; // Update for capture
            });

            barcodeDataInput.addEventListener('input', () => {
                const barcodeValue = barcodeDataInput.value;

                // Update the immediate preview (this part was working)
                if (barcodeValue) {
                    JsBarcode(barcodeDisplayDiv, barcodeValue, {
                        format: "CODE128",
                        lineColor: "#000",
                        width: 1.5, // Slightly thinner for preview
                        height: 70,
                        fontSize: 14,
                        displayValue: true,
                        textAlign: "center"
                    });
                } else {
                    barcodeDisplayDiv.innerHTML = ''; // Clear preview if input is empty
                }
                // We will re-render to barcodeSvgElement when the button is clicked.
            });

            // Function to update the expiration date display and populate the print area
            const updateExpirationDisplay = () => {
                const day = expDayInput.value.padStart(2, '0');
                const month = expMonthInput.value.padStart(2, '0');
                const year = expYearInput.value;

                if (day && month && year) {
                    printExpSpan.textContent = `${day}/${month}/${year}`; // Update for capture
                } else {
                    printExpSpan.textContent = ''; // Clear if any part is missing
                }
            };

            expDayInput.addEventListener('input', updateExpirationDisplay);
            expMonthInput.addEventListener('input', updateExpirationDisplay);
            expYearInput.addEventListener('input', updateExpirationDisplay);

            // Initial call to set the display if there's pre-filled data (optional)
            updateExpirationDisplay();


            // --- Image Capture Functionality ---

            generateImageBtn.addEventListener('click', () => {
                // 1. Ensure all current inputs are reflected in the hidden 'captureArea'
                printNameSpan.textContent = nameInput.value;
                updateExpirationDisplay(); // Re-render the date display for capture

                const barcodeValue = barcodeDataInput.value;
                if (barcodeValue) {
                    // *** THIS IS THE CRITICAL FIX ***
                    // Render the barcode directly to the SVG element WITHIN captureArea
                    // that html2canvas will capture.
                    JsBarcode(barcodeSvgElement, barcodeValue, {
                        format: "CODE128",
                        lineColor: "#000",
                        width: 2, // Standard width for final output
                        height: 100,
                        fontSize: 16,
                        displayValue: true,
                        textAlign: "center"
                    });
                } else {
                    barcodeSvgElement.innerHTML = ''; // Clear SVG if input is empty
                }

                // 2. Use html2canvas to capture the 'captureArea' div
                // Give a small delay to ensure JsBarcode has finished rendering.
                setTimeout(() => {
                    html2canvas(captureArea, {
                        useCORS: true,
                        logging: true
                    }).then(canvas => {
                        // Convert the canvas to a data URL (PNG format)
                        const imgData = canvas.toDataURL("image/png");

                        // Display the generated image and provide instructions
                        const outputImageContainer = document.getElementById('outputImageContainer');
                        outputImageContainer.innerHTML = `
                            <p>Right-click on the image below and select "Copy Image" or "Save Image As..."</p>
                            <img src="${imgData}" alt="Generated Barcode" style="max-width: 100%; height: auto; border: 1px solid #ccc;">
                        `;
                    }).catch(err => {
                        console.error("Error capturing image:", err);
                        alert("Failed to capture image. Please check the console for more details.");
                    });
                }, 100); // 100ms delay
            });
        });
    </script>
</body>
</html>
